Module Code =============
Option Explicit

Public Sub LoginUser()
    Dim wsLogin As Worksheet, wsUser As Worksheet
    Dim entID As String

    Set wsLogin = Sheets("Login")
    entID = Trim(wsLogin.Range("B3").value)

    If entID = "" Then
        MsgBox "Please select your Enterprise ID from the dropdown.", vbExclamation, "Login Required"
        wsLogin.Range("B3").Select
        Exit Sub
    End If

    ' Check if user sheet exists
    On Error Resume Next
    Set wsUser = Sheets(entID)
    On Error GoTo 0

    If wsUser Is Nothing Then
        MsgBox "User Not found. Please add User to continue.", vbExclamation, "User Not Found"
        Exit Sub
    End If

    ' Don't hide other users' sheets - allow multiple users
    wsUser.Visible = xlSheetVisible

    ' Sync B3 value to D6 in user sheet
    wsUser.Unprotect
    wsUser.Range("D6").value = entID
    wsUser.Range("D6").Locked = True
    wsUser.Protect UserInterfaceOnly:=True, AllowFiltering:=True

    ' Activate user sheet, select cell D8, and set zoom to 80%
    wsUser.Activate
    wsUser.Range("D12").Select
    ActiveWindow.Zoom = 80
MsgBox "Welcome, " & Application.userName & "!" & vbNewLine & _
       "ID *" & entID & "* logged in successfully." & vbNewLine & _
       "Your timesheet is ready." & vbNewLine & vbNewLine & _
       "Have a productive day!", _
       vbInformation, "Login Successful"


End Sub





' ==== SUBMIT TIMESHEET WITH FIXED NUMBERING ====
Public Sub SubmitTimesheet()
    On Error GoTo ErrorHandler

    Dim wsForm As Worksheet, wsDB As Worksheet
    Dim nextRow As Long
    Dim timesheetType As String, enterpriseID As String, uniqueCode As String
    Dim employeeName As String, employeeEmail As String, monthName As String, WeekName As String, regionName As String
    Dim engagementID As String, engagementHours As Variant, teamName As String
    Dim nonAuditEngagementName As String, nonAuditEngagementHours As Variant, remarks As String
    Dim submittedBy As String, debugMsg As String
    Dim isCorrection As Boolean
    Dim combinedMonthWeek As String

    Set wsForm = ActiveSheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    debugMsg = "Starting submission process..." & vbCrLf

    ' Gather all form values
    enterpriseID = Trim(wsForm.Range("D6").value)
    employeeName = Trim(wsForm.Range("D8").value)
    employeeEmail = Trim(wsForm.Range("D10").value)
    timesheetType = Trim(wsForm.Range("D12").value)
    monthName = Trim(wsForm.Range("D14").value)
    WeekName = Trim(wsForm.Range("E14").value)
    combinedMonthWeek = monthName & " : " & WeekName
    regionName = Trim(wsForm.Range("D16").value)
    engagementID = Trim(wsForm.Range("H6").value)
    engagementHours = wsForm.Range("H8").value
    teamName = Trim(wsForm.Range("H10").value)
    nonAuditEngagementName = Trim(wsForm.Range("H12").value)
    nonAuditEngagementHours = wsForm.Range("H14").value
    remarks = Trim(wsForm.Range("H16").value)
    uniqueCode = Trim(wsForm.Range("AT1").value)
    submittedBy = Application.userName

    ' Check if this is a correction
    isCorrection = LCase(timesheetType) = "timesheet entry correction"

    ' Validations
    If Not ValidateRequiredFields(wsForm, enterpriseID, timesheetType, monthName, WeekName, regionName, teamName) Then GoTo CleanUp
    If Not ValidateEngagementPairs(wsForm) Then GoTo CleanUp

    debugMsg = debugMsg & "Validation passed" & vbCrLf

    ' Disable events during processing
    Application.EnableEvents = False
    Application.ScreenUpdating = False

    ' CRITICAL: Ensure sheet is unprotected for writing
    wsForm.Unprotect
    debugMsg = debugMsg & "Sheet unprotected" & vbCrLf

    ' FIXED CORRECTION LOGIC WITH PRESERVED NUMBERING
    If isCorrection Then
        If uniqueCode = "" Then
            MsgBox "Unique code missing for correction.", vbExclamation
            GoTo CleanUp
        End If

        ' Store the original code to preserve it
        Dim originalCode As String
        originalCode = uniqueCode

      Dim foundLocalRow As Long, foundDBRow As Long
        foundLocalRow = FindLocalRow(wsForm, uniqueCode, enterpriseID)
        foundDBRow = FindDBRow(wsDB, uniqueCode, enterpriseID)

        If foundLocalRow = 0 And foundDBRow = 0 Then
            MsgBox "Record not found in local storage or database. Please select New Timesheet Entry.", _
                   vbExclamation, "Record Not Found"
            wsForm.Range("D12").value = "New Timesheet entry"
            ClearCorrectionFields wsForm
            GoTo CleanUp
        ElseIf foundLocalRow > 0 Then
            ' Mark for deletion instead of deleting immediately
            MarkLocalRowForDeletion wsForm, uniqueCode, enterpriseID
            debugMsg = debugMsg & "Local record marked for deletion for correction" & vbCrLf
        ElseIf foundDBRow > 0 Then
            ' Load from database and mark for deletion in DB
            LoadFromDatabase wsForm, wsDB, foundDBRow
            wsDB.Unprotect
            MarkDBRowForDeletion wsDB, foundDBRow
            wsDB.Protect UserInterfaceOnly:=True
            debugMsg = debugMsg & "Database record loaded and marked for deletion for correction" & vbCrLf
        End If

        ' CRITICAL: Preserve the original unique code for corrections
        uniqueCode = originalCode
        debugMsg = debugMsg & "Correction mode - preserved original code: " & uniqueCode & vbCrLf
    Else
       ' Check for duplicates in new entries
If LCase(timesheetType) = "new timesheet entry" Then
    Dim duplicateLocalRow As Long, duplicateDBRow As Long
    duplicateLocalRow = FindDuplicateLocal(wsForm, enterpriseID, engagementID, monthName, WeekName, regionName, teamName)
    duplicateDBRow = FindDuplicateDB(wsDB, enterpriseID, engagementID, monthName, WeekName, regionName, teamName)

    If duplicateLocalRow > 0 Or duplicateDBRow > 0 Then
        Dim duplicateCode As String
        If duplicateLocalRow > 0 Then
            duplicateCode = wsForm.Cells(duplicateLocalRow, 2).value
        Else
            duplicateCode = wsDB.Cells(duplicateDBRow, 1).value
        End If

        Dim response As VbMsgBoxResult
        response = MsgBox("This entry already exists (Unique Code: " & duplicateCode & ")." & vbNewLine & _
                          "Do you want to make a correction instead?", vbYesNo + vbExclamation, "Duplicate Entry")

        If response = vbYes Then
            wsForm.Range("D12").value = "Timesheet Entry Correction"
            wsForm.Range("AT1").value = duplicateCode
            MsgBox "Please proceed with the correction using the existing data.", vbInformation, "Correction Mode"
            Exit Sub
        Else
            MsgBox "Submission cancelled. Please review your entry.", vbInformation, "Submission Cancelled"
            Exit Sub
        End If
    End If
End If

        ' FIXED: Get next sequential code checking both local and database
        uniqueCode = GetNextLocalCode(wsForm)
        debugMsg = debugMsg & "New entry, assigned sequential code: " & uniqueCode & vbCrLf
    End If

    ' Confirmation
    If MsgBox("Are you sure you want to submit the timesheet?" & vbCrLf & "Code: " & uniqueCode, _
              vbQuestion + vbYesNo, "Confirm Submission") = vbNo Then
        MsgBox "Submission cancelled.", vbInformation
        GoTo CleanUp
    End If
    ' If this is a correction, delete any previous corrections for this unique code
If isCorrection Then
    DeletePreviousCorrections wsForm, uniqueCode, enterpriseID
End If


    ' Find next storage row
    nextRow = wsForm.Cells(wsForm.Rows.count, "B").End(xlUp).Row
    If nextRow < 3000 Then nextRow = 2999
    nextRow = nextRow + 1
    debugMsg = debugMsg & "Writing to row: " & nextRow & vbCrLf

   ' Write data to local storage with verification
    With wsForm
        .Cells(nextRow, 2).value = uniqueCode
        .Cells(nextRow, 3).value = enterpriseID
        .Cells(nextRow, 4).value = employeeName
        .Cells(nextRow, 5).value = employeeEmail
        .Cells(nextRow, 6).value = Format(Now, "yyyy-mm-dd hh:mm:ss")
        .Cells(nextRow, 7).value = timesheetType
        .Cells(nextRow, 8).value = combinedMonthWeek ' Store combined month and week
        .Cells(nextRow, 9).value = regionName
        .Cells(nextRow, 10).value = engagementID
        .Cells(nextRow, 11).value = engagementHours
        .Cells(nextRow, 12).value = teamName
        .Cells(nextRow, 13).value = nonAuditEngagementName
        .Cells(nextRow, 14).value = nonAuditEngagementHours
        .Cells(nextRow, 15).value = remarks
        .Cells(nextRow, 16).value = submittedBy
        ' Colur of Font no fill
         .Cells(nextRow, 2).Resize(1, 15).Font.Color = RGB(255, 255, 255)
    End With
    

    ' Verify data was written correctly
    If wsForm.Cells(nextRow, 2).value <> uniqueCode Then
        MsgBox "CRITICAL ERROR: Data verification failed!" & vbCrLf & _
               "Expected code: " & uniqueCode & vbCrLf & _
               "Found: " & wsForm.Cells(nextRow, 2).value, vbCritical
        GoTo CleanUp
    End If

    debugMsg = debugMsg & "Data written and verified successfully" & vbCrLf

    ' Auto-save workbook
    ThisWorkbook.Save
    debugMsg = debugMsg & "Workbook saved" & vbCrLf

    ' Success message
    Dim msgType As String
    msgType = IIf(isCorrection, "CORRECTION", "NEW ENTRY")

    MsgBox "SUCCESS! " & msgType & " stored locally!" & vbCrLf & _
           "Unique Code: " & uniqueCode & vbCrLf & _
           "Enterprise ID: " & enterpriseID & vbCrLf & _
           "Will be synced to database By Admin." & vbCrLf & vbCrLf & _
           "Use ' Double Click to Show Past Records' to view your latest submissions.", vbInformation, "Submission Complete"

    ' Reset form inputs only (preserve local storage and past records)
    ResetFormInputsOnly wsForm

    GoTo CleanUp

ErrorHandler:
    MsgBox "ERROR in SubmitTimesheet:" & vbCrLf & _
           "Error: " & Err.Description & vbCrLf & _
           "Number: " & Err.Number & vbCrLf & vbCrLf & _
           "Debug Info:" & vbCrLf & debugMsg, vbCritical, "System Error"

CleanUp:
    On Error Resume Next
    wsForm.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Call UpdatePendingCounts

    ' Ensure we stay on the user's sheet
    wsForm.Activate
End Sub

' ==== FIXED UNIQUE CODE GENERATION - CHECKS BOTH LOCAL AND DATABASE ====
Private Function GetNextLocalCode(ws As Worksheet) As String
    Dim maxCodeLocal As Long, maxCodeDB As Long
    Dim r As Long, lastRow As Long
    Dim entID As String
    
    entID = ws.Range("D6").value
    
    ' Check local storage for this Enterprise ID
    maxCodeLocal = 0
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
    For r = 3000 To lastRow
        If ws.Cells(r, 3).value = entID Then ' Column C = Enterprise ID
            If IsNumeric(ws.Cells(r, 2).value) And ws.Cells(r, 2).value <> "" Then
                If ws.Cells(r, 2).value > maxCodeLocal Then
                    maxCodeLocal = ws.Cells(r, 2).value
                End If
            End If
        End If
    Next r
    
    ' Check database records for this Enterprise ID
    Dim wsDB As Worksheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    maxCodeDB = 0
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = 2 To lastRow ' Start from row 2 (skip header)
        If wsDB.Cells(r, 2).value = entID Then ' Column B = Enterprise ID in database
            If IsNumeric(wsDB.Cells(r, 1).value) And wsDB.Cells(r, 1).value <> "" Then
                If wsDB.Cells(r, 1).value > maxCodeDB Then
                    maxCodeDB = wsDB.Cells(r, 1).value
                End If
            End If
        End If
    Next r
    
    ' The next code is the higher of both + 1
    GetNextLocalCode = CStr(Application.Max(maxCodeLocal, maxCodeDB) + 1)
End Function

' ==== HELPER FUNCTIONS FOR DATABASE CORRECTION ====
Private Function FindDBRow(wsDB As Worksheet, code As String, entID As String) As Long
    Dim lastRow As Long, r As Long
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = 2 To lastRow
        If wsDB.Cells(r, 1).value = code And wsDB.Cells(r, 2).value = entID Then
            FindDBRow = r
            Exit Function
        End If
    Next r
    FindDBRow = 0
End Function

Private Sub LoadFromDatabase(wsForm As Worksheet, wsDB As Worksheet, dbRow As Long)
    Dim combinedMonthWeek As String
    Dim monthPart As String, weekPart As String

    combinedMonthWeek = wsDB.Cells(dbRow, 7).value ' Combined Month_Week

    ' Split the combined value
    If InStr(combinedMonthWeek, " : ") > 0 Then
        monthPart = Split(combinedMonthWeek, " : ")(0)
        weekPart = Split(combinedMonthWeek, " : ")(1)
    Else
        monthPart = combinedMonthWeek
        weekPart = ""
    End If

    wsForm.Range("D14").value = monthPart ' Month
    wsForm.Range("E14").value = weekPart ' Week
    wsForm.Range("D16").value = wsDB.Cells(dbRow, 8).value ' Region
    wsForm.Range("H6").value = wsDB.Cells(dbRow, 9).value ' Engagement ID
    wsForm.Range("H8").value = wsDB.Cells(dbRow, 10).value ' Engagement Hours
    wsForm.Range("H10").value = wsDB.Cells(dbRow, 11).value ' Team Name
    wsForm.Range("H12").value = wsDB.Cells(dbRow, 12).value ' Non-Audit Name
    wsForm.Range("H14").value = wsDB.Cells(dbRow, 13).value ' Non-Audit Hours
    wsForm.Range("H16").value = wsDB.Cells(dbRow, 14).value ' Remarks
End Sub

    

' ==== TOGGLE MY DATABASE RECORDS (ENHANCED) ====
Public Sub ToggleMyDatabaseRecords()
    Dim wsF As Worksheet, wsDB As Worksheet
    Dim entID As String, i As Long, lastRow As Long, outRow As Long
    Dim startCell As Range, tblArea As Range
    Dim isDataPresent As Boolean

    Set wsF = ActiveSheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    Set startCell = wsF.Range("B25")
    Set tblArea = wsF.Range("B25:Q297") ' CAREFUL: Ends before row 3000 (local storage)

    entID = Trim(wsF.Range("D6").value)
    If entID = "" Then
        MsgBox "Please verify Enterprise ID is populated.", vbExclamation
        Exit Sub
    End If

    ' Unprotect the sheet
    On Error Resume Next
    wsF.Unprotect
    On Error GoTo 0

    ' Check if data exists below the header
    isDataPresent = WorksheetFunction.CountA(tblArea.Offset(1)) > 0

    If isDataPresent Then
        ' Clear existing data
        tblArea.Offset(1).ClearContents
        tblArea.Offset(1).ClearFormats
        tblArea.Offset(1).Interior.ColorIndex = xlNone
        tblArea.Offset(1).Borders.LineStyle = xlNone

        ' Clear headers as well
        startCell.Resize(1, 16).ClearContents
        startCell.Resize(1, 16).ClearFormats

        ' Reprotect the sheet
        On Error Resume Next
        wsF.Protect UserInterfaceOnly:=True, AllowFiltering:=True
        On Error GoTo 0
        MsgBox "You past timesheet records have been hidden. Please click again to show them", vbInformation, "Toggle Complete"
        Exit Sub
    End If

    ' If we reach here, it means there's no data, so we proceed to show records

   ' Headers
    startCell.Resize(1, 16).value = Array("Unique Code", "Enterprise ID", "Employee Name", "Employee Email", _
        "Submitted Time", "Type", "Month_Week", "Region", "Engagement ID", "Engagement Hr", "Team Name", _
        "Non-Audit Eng Name", "Non-Audit Hr", "Remarks", "Submitted By", "Sync Status")
        
    With startCell.Resize(1, 16)
        .Font.Bold = True
        .Interior.Color = RGB(200, 200, 200)
        .Borders.LineStyle = xlContinuous
        .HorizontalAlignment = xlCenter
    End With

    outRow = 1

    ' Show database records (synced) - sorted by unique code
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    If lastRow >= 2 Then
        For i = 2 To lastRow
        
            If wsDB.Cells(i, 2).value = entID Then
                startCell.Offset(outRow).Resize(1, 15).value = wsDB.Range(wsDB.Cells(i, 1), wsDB.Cells(i, 15)).value
                startCell.Offset(outRow, 15).value = "Synced"
                startCell.Offset(outRow, 15).Interior.Color = RGB(200, 255, 200) ' Light green
                outRow = outRow + 1
            End If
        Next i
    End If

    ' Show local pending records - sorted by unique code
    Dim localLastRow As Long
    localLastRow = wsF.Cells(wsF.Rows.count, "B").End(xlUp).Row
    If localLastRow >= 3000 Then
        For i = 3000 To localLastRow
            If wsF.Cells(i, 2).value <> "" And wsF.Cells(i, 3).value = entID Then
                startCell.Offset(outRow).Resize(1, 15).value = wsF.Range(wsF.Cells(i, 2), wsF.Cells(i, 16)).value
                startCell.Offset(outRow, 15).value = "Pending Sync"
                startCell.Offset(outRow, 15).Interior.Color = RGB(255, 255, 200) ' Light yellow
                outRow = outRow + 1
            End If
        Next i
    End If

    ' Format data rows
    If outRow > 1 Then
        With startCell.Offset(1).Resize(outRow - 1, 16)
            .Borders.LineStyle = xlContinuous
            .HorizontalAlignment = xlLeft
        End With

        ' Alternate row colors
        For i = 2 To outRow - 1 Step 2
            startCell.Offset(i).Resize(1, 16).Interior.Color = RGB(240, 240, 240)
        Next i

        MsgBox outRow - 1 & " Record(s) displayed for " & entID
    Else
        MsgBox "No records found for Enterprise ID: " & entID, vbInformation, "No Records"
    End If

    ' Reprotect the sheet
    On Error Resume Next
    wsF.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    On Error GoTo 0
End Sub
' ==== NEW FUNCTION TO MARK LOCAL ROW FOR DELETION ====
Private Sub MarkLocalRowForDeletion(ws As Worksheet, code As String, entID As String)
    Dim r As Long
    r = FindLocalRow(ws, code, entID)
    If r > 0 Then
        ws.Cells(r, 17).value = "Marked for Deletion" ' Assuming column Q is unused
        ws.Cells(r, 17).Interior.Color = RGB(255, 200, 200) ' Light red background
    End If
End Sub

' ==== NEW FUNCTION TO MARK DB ROW FOR DELETION ====
Private Sub MarkDBRowForDeletion(wsDB As Worksheet, dbRow As Long)
    wsDB.Cells(dbRow, 16).value = "Marked for Deletion" ' Assuming column P is unused in DB
    wsDB.Cells(dbRow, 16).Interior.Color = RGB(255, 200, 200) ' Light red background
End Sub

' ==== ADMIN SYNC WITH PASSWORD ====
Public Sub SyncAllUserSheetsToDatabase()
    On Error GoTo ErrorHandler

    Dim pass As String
    pass = InputBox("Enter sync password:", "Admin Sync Required")
    If pass <> "123" Then
        MsgBox "Incorrect password. Access denied.", vbCritical, "Access Denied"
        Exit Sub
    End If

    Dim ws As Worksheet, wsDB As Worksheet, wsLogin As Worksheet, wsAdmin As Worksheet
    Dim r As Long, lastLocalRow As Long, nextDBRow As Long
    Dim recordCount As Long, userCount As Long, deletedCount As Long

    recordCount = 0
    userCount = 0
    deletedCount = 0
    Set wsDB = ThisWorkbook.Sheets("Data base")
    Set wsAdmin = ThisWorkbook.Sheets("Admin")

    wsDB.Unprotect

    ' First, process deletions in the database
    Dim lastDBRow As Long
    lastDBRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = lastDBRow To 2 Step -1
        If wsDB.Cells(r, 16).value = "Marked for Deletion" Then
            wsDB.Rows(r).Delete
            deletedCount = deletedCount + 1
        End If
    Next r
    ' Create a collection to store the latest corrections
Dim latestCorrections As New Collection
On Error Resume Next ' In case of duplicate keys

' First pass: identify the latest corrections
For r = lastLocalRow To 3000 Step -1
    If ws.Cells(r, 2).value <> "" Then
        Dim key As String
        key = ws.Cells(r, 2).value & "_" & ws.Cells(r, 3).value ' Unique Code + Enterprise ID
        If LCase(ws.Cells(r, 7).value) = "timesheet entry correction" Then
            latestCorrections.Add r, key
        End If
    End If
Next r

On Error GoTo 0 ' Reset error handling



    ' Process each user sheet
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Data base" And ws.Name <> "Login" And ws.Name <> "Admin" Then
            lastLocalRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
            If lastLocalRow >= 3000 Then
                Dim userRecords As Long: userRecords = 0
                For r = 3000 To lastLocalRow
                    If ws.Cells(r, 2).value <> "" Then
                        If ws.Cells(r, 17).value <> "Marked for Deletion" Then
                            nextDBRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row + 1
                            wsDB.Cells(nextDBRow, 1).Resize(1, 15).value = ws.Cells(r, 2).Resize(1, 15).value
                            recordCount = recordCount + 1
                            userRecords = userRecords + 1
                        Else
                            deletedCount = deletedCount + 1
                        End If
                    End If
                Next r

                If userRecords > 0 Or deletedCount > 0 Then
                    ' Unprotect the sheet before clearing contents
                    On Error Resume Next
                    ws.Unprotect
                    On Error GoTo ErrorHandler

                    ' Clear local storage after successful sync
                    ws.Range("B3000:Q" & lastLocalRow).ClearContents
                    ws.Range("B3000:Q" & lastLocalRow).Interior.ColorIndex = xlNone
                    userCount = userCount + 1

                    ' Protect the sheet again
                    On Error Resume Next
                    ws.Protect
                    On Error GoTo ErrorHandler
                End If
            End If
        End If
    Next ws

    wsDB.Protect UserInterfaceOnly:=True

    ' Update sync timestamp
    wsAdmin.Range("G5").value = Format(Now, "yyyy-mm-dd hh:mm:ss")

    ' Save workbook
    ThisWorkbook.Save

    MsgBox "SYNC COMPLETED!" & vbCrLf & _
           "Users processed: " & userCount & vbCrLf & _
           "Records synced: " & recordCount & vbCrLf & _
           "Records deleted: " & deletedCount & vbCrLf & _
           "All local buffers cleared." & vbCrLf & _
           "Last sync: " & Format(Now, "yyyy-mm-dd hh:mm:ss"), vbInformation, "Sync Complete"
    Call UpdatePendingCounts
    Call LogoutAllUserSheets
    Exit Sub

ErrorHandler:
    MsgBox "An error occurred: " & Err.Description, vbCritical, "Error"
    On Error Resume Next
    wsDB.Protect UserInterfaceOnly:=True
    ThisWorkbook.Save
End Sub


' ==== SUPPORT FUNCTIONS ====
Private Function FindLocalRow(ws As Worksheet, code As String, entID As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
    For r = 3000 To lastRow
        If ws.Cells(r, 2).value = code And ws.Cells(r, 3).value = entID Then
            FindLocalRow = r
            Exit Function
        End If
    Next r
    FindLocalRow = 0
End Function

Private Sub DeleteLocalRow(ws As Worksheet, code As String, entID As String)
    Dim r As Long
    r = FindLocalRow(ws, code, entID)
    If r > 0 Then ws.Rows(r).Delete Shift:=xlUp
End Sub
Private Function FindDuplicateLocal(ws As Worksheet, enterpriseID As String, engagementID As String, monthName As String, WeekName As String, regionName As String, teamName As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
    For r = 3000 To lastRow
        If LCase(ws.Cells(r, 3).value) = LCase(enterpriseID) And _
           LCase(ws.Cells(r, 10).value) = LCase(engagementID) And _
           LCase(Split(ws.Cells(r, 8).value, " : ")(0)) = LCase(monthName) And _
           LCase(Split(ws.Cells(r, 8).value, " : ")(1)) = LCase(WeekName) And _
           LCase(ws.Cells(r, 9).value) = LCase(regionName) And _
           LCase(ws.Cells(r, 12).value) = LCase(teamName) And _
           LCase(ws.Cells(r, 7).value) = "new timesheet entry" Then
           FindDuplicateLocal = r
           Exit Function
        End If
    Next r
    FindDuplicateLocal = 0
End Function
Private Function FindDuplicateDB(wsDB As Worksheet, enterpriseID As String, engagementID As String, monthName As String, WeekName As String, regionName As String, teamName As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = 2 To lastRow
        If LCase(wsDB.Cells(r, 2).value) = LCase(enterpriseID) And _
           LCase(wsDB.Cells(r, 9).value) = LCase(engagementID) And _
           LCase(Split(wsDB.Cells(r, 7).value, " : ")(0)) = LCase(monthName) And _
           LCase(Split(wsDB.Cells(r, 7).value, " : ")(1)) = LCase(WeekName) And _
           LCase(wsDB.Cells(r, 8).value) = LCase(regionName) And _
           LCase(wsDB.Cells(r, 11).value) = LCase(teamName) Then
           FindDuplicateDB = r
           Exit Function
        End If
    Next r
    FindDuplicateDB = 0
End Function


' ==== VALIDATIONS ====
Private Function ValidateRequiredFields(wsForm As Worksheet, enterpriseID As String, timesheetType As String, monthName As String, WeekName As String, regionName As String, teamName As String) As Boolean
    ValidateRequiredFields = True
    If enterpriseID = "" Then
        MsgBox "Enterprise ID is required.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If timesheetType = "" Then
        MsgBox "Please select Timesheet Type.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If monthName = "" Then
        MsgBox "Please select Month.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If WeekName = "" Then
        MsgBox "Please select Week", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If regionName = "" Then
        MsgBox "Please select Region.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If teamName = "" Then
        MsgBox "Please select Your Team.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
End Function

Private Function ValidateEngagementPairs(wsForm As Worksheet) As Boolean
    Dim engagementFilled As Boolean, nonAuditEngagementFilled As Boolean
    engagementFilled = (Len(Trim(wsForm.Range("H6").value)) > 0 And Len(Trim(wsForm.Range("H8").value)) > 0)
    nonAuditEngagementFilled = (Len(Trim(wsForm.Range("H12").value)) > 0 And Len(Trim(wsForm.Range("H14").value)) > 0)
    
    ValidateEngagementPairs = True
    If Not (engagementFilled Or nonAuditEngagementFilled) Then
        MsgBox "Please fill either Engagement ID + Hours OR Non-Audit Engagement + Hours.", vbExclamation, "Validation Error"
        ValidateEngagementPairs = False: Exit Function
    End If
    
    If (Len(Trim(wsForm.Range("H6").value)) > 0 Xor Len(Trim(wsForm.Range("H8").value)) > 0) _
        Or (Len(Trim(wsForm.Range("H12").value)) > 0 Xor Len(Trim(wsForm.Range("H14").value)) > 0) Then
        MsgBox "Please ensure both fields are filled for the selected engagement type.", vbExclamation, "Validation Error"
        ValidateEngagementPairs = False: Exit Function
    End If
End Function

' ==== FORM MANAGEMENT ====
Private Sub ResetFormInputsOnly(f As Worksheet)
    Application.EnableEvents = False
    f.Unprotect
    
    ' Store existing formulas
    Dim nameFormula As String, emailFormula As String
    nameFormula = f.Range("D8").Formula
    emailFormula = f.Range("D10").Formula
    
    ' Clear only form input fields (NOT past records display or local storage)
    f.Range("D12,D14,E14,D16,H6,H8,H10,H12,H14,H16,AT1").ClearContents
    f.Range("D12").value = "New Timesheet Entry"
    
    ' Restore XLOOKUP formulas
    If nameFormula <> "" Then f.Range("D8").Formula = nameFormula
    If emailFormula <> "" Then f.Range("D10").Formula = emailFormula
    
    ' Maintain protection settings
    f.Cells.Locked = True
    f.Range("D6,D8,D10").Locked = True
    f.Range("D12,D14,E14,D16,H6,H8,H10,H12,H14,H16").Locked = False
    f.Range("B3000:Q" & f.Rows.count).Locked = False ' Keep storage area unlocked
    
    f.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
End Sub

Public Sub ClearCorrectionFields(f As Worksheet)
    Application.EnableEvents = False
    f.Unprotect
    f.Range("D12,D14,E14,D16,H6,H8,H10,H12,H14,H16,AT1").ClearContents
    f.Range("D12").value = "New Timesheet Entry"
    f.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
End Sub
' ==== Delete correction locally ====
Private Sub DeletePreviousCorrections(ws As Worksheet, uniqueCode As String, enterpriseID As String)
    Dim lastRow As Long, r As Long
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row

    For r = lastRow To 3000 Step -1
        If ws.Cells(r, 2).value = uniqueCode And _
           ws.Cells(r, 3).value = enterpriseID And _
           LCase(ws.Cells(r, 7).value) = "timesheet entry correction" Then
            ws.Rows(r).Delete
        End If
    Next r
End Sub

' ==== LOGOUT FUNCTION (ENHANCED) ====
Public Sub LogoutUser()
    Dim response As VbMsgBoxResult
    response = MsgBox("Are you sure you want to logout?" & vbCrLf & _
                     "This will hide your Sheet.", vbYesNo + vbQuestion, "Confirm Logout")
    
    If response = vbYes Then
        ActiveSheet.Visible = xlSheetVeryHidden
        Sheets("Login").Activate
        Sheets("Login").Range("B3").ClearContents
        Sheets("Login").Range("B3").Select
        MsgBox "Logged out successfully. Please Close This Excel", vbInformation
    End If
End Sub

' ==== ADMIN FUNCTIONS ====
Public Sub ShowAllUserSheets()
    If InputBox("Enter admin password:") <> "123" Then
        MsgBox "Access denied": Exit Sub
    End If
    
    Dim ws As Worksheet, count As Long
    count = 0
    
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" Then
            ws.Visible = xlSheetVisible
            count = count + 1
        End If
    Next ws
    
    MsgBox count & " user sheets are now visible.", vbInformation
End Sub

Public Sub HideAllUserSheets()
    If InputBox("Enter admin password:") <> "123" Then
        MsgBox "Access denied": Exit Sub
    End If
    
    Dim ws As Worksheet, count As Long
    count = 0
    
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" Then
            ws.Visible = xlSheetVeryHidden
            count = count + 1
        End If
    Next ws
    
    Sheets("Login").Activate
    MsgBox count & " user sheets have been hidden.", vbInformation
End Sub
Public Sub LogoutAllUserSheets()
    Dim ws As Worksheet, count As Long
    count = 0

    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And ws.Name <> "Admin" Then
            ws.Visible = xlSheetVeryHidden
            count = count + 1
        End If
    Next ws

    Sheets("Admin").Activate
End Sub



Public Sub UpdatePendingCounts()
    Dim ws As Worksheet
    Dim totalPending As Long
    Dim userCount As Long
    Dim lastRow As Long
    Dim sheetPending As Long
    
    totalPending = 0
    userCount = 0
    
    For Each ws In ThisWorkbook.Sheets
        ' Skip non-user sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And ws.Name <> "DV" And ws.Name <> "Admin" Then
            lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
            If lastRow >= 3000 Then
                sheetPending = Application.WorksheetFunction.CountA(ws.Range("B3000:B" & lastRow))
                If sheetPending > 0 Then
                    totalPending = totalPending + sheetPending
                    userCount = userCount + 1
                End If
            End If
        End If
    Next ws
    
    ' Output to Admin sheet
    With ThisWorkbook.Sheets("Admin")
        .Range("G3").value = totalPending
        .Range("G4").value = userCount
    End With
End Sub

user sheet cde=========================================
Private Sub Worksheet_Change(ByVal Target As Range)
    Static isProcessing As Boolean
    If isProcessing Then Exit Sub

    isProcessing = True
    Application.EnableEvents = False


    ' Engagement ID requires Region (D16)
    If Not Intersect(Target, Me.Range("H6")) Is Nothing Then
        If Trim(Me.Range("D16").value) = "" Then
            MsgBox "Please select Region first.", vbExclamation, "Selection Required"
            Me.Range("H6").ClearContents
            Me.Range("D16").Select
            GoTo CleanUp
        End If
    End If

    ' Region changed: clear Engagement ID (H6)
    If Not Intersect(Target, Me.Range("D16")) Is Nothing Then
        If Trim(Me.Range("H6").value) <> "" Then
            Me.Unprotect
            Me.Range("H6").ClearContents
            Me.Protect UserInterfaceOnly:=True, AllowFiltering:=True
            MsgBox "Region changed. Engagement ID cleared.", vbInformation, "Field Cleared"
        End If
    End If

    ' ENHANCED: Timesheet Type Correction with Auto-Fill
    If Not Intersect(Target, Me.Range("D12")) Is Nothing Then
        If LCase$(Trim(Me.Range("D12").value)) = "timesheet entry correction" Then
            If Trim(Me.Range("D6").value) = "" Then
                MsgBox "Enterprise ID required for correction.", vbExclamation
                Me.Range("D12").value = "New Timesheet Entry"
                GoTo CleanUp
            End If

            Dim code As String
            code = InputBox("Enter Unique Code to correct:", "Correction Code Required")
            If code = "" Then
                MsgBox "Correction cancelled.", vbInformation
                Me.Range("D12").value = "New Timesheet Entry"
                GoTo CleanUp
            End If

            ' Store the code in a hidden cell
            Me.Unprotect
            Me.Range("AT1").value = code
            Me.Protect UserInterfaceOnly:=True, AllowFiltering:=True

            ' ENHANCED: Auto-fill from BOTH local storage AND database
            If AutoFillCorrectionData(Me, code, Me.Range("D6").value) Then
                MsgBox "Record found and loaded for correction!" & vbCrLf & _
                       "Unique Code: " & code & vbCrLf & _
                       "Modify any fields you want and click Submit.", vbInformation, "Correction Loaded"
            Else
                MsgBox "Record not found in local storage or database." & vbCrLf & _
                       "Please check the Unique Code and try again.", vbExclamation, "Record Not Found"
                Me.Range("D12").value = "New Timesheet Entry"
                Me.Unprotect
                Me.Range("AT1").ClearContents
                Me.Protect UserInterfaceOnly:=True, AllowFiltering:=True
            End If
        Else
            Me.Unprotect
            Me.Range("AT1").ClearContents
            Me.Protect UserInterfaceOnly:=True, AllowFiltering:=True
        End If
    End If

CleanUp:
    Application.EnableEvents = True
    isProcessing = False
End Sub

' ENHANCED: Auto-fill function that checks BOTH local and database
Private Function AutoFillCorrectionData(ws As Worksheet, code As String, entID As String) As Boolean
    Dim foundRow As Long
    AutoFillCorrectionData = False
    
    ' First, check local storage (rows 300+)
    foundRow = FindLocalRecordRow(ws, code, entID)
    If foundRow > 0 Then
        ' Auto-fill from local storage
        LoadDataFromLocalRow ws, foundRow
        AutoFillCorrectionData = True
        Exit Function
    End If
    
    ' If not found locally, check database
    Dim wsDB As Worksheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    foundRow = FindDatabaseRecordRow(wsDB, code, entID)
    If foundRow > 0 Then
        ' Auto-fill from database
        LoadDataFromDatabaseRow ws, wsDB, foundRow
        AutoFillCorrectionData = True
        Exit Function
    End If
End Function

Private Function FindLocalRecordRow(ws As Worksheet, code As String, entID As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
    For r = 3000 To lastRow
        If ws.Cells(r, 2).value = code And ws.Cells(r, 3).value = entID Then
            FindLocalRecordRow = r
            Exit Function
        End If
    Next r
    FindLocalRecordRow = 0
End Function

Private Function FindDatabaseRecordRow(wsDB As Worksheet, code As String, entID As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = 2 To lastRow
        If wsDB.Cells(r, 1).value = code And wsDB.Cells(r, 2).value = entID Then
            FindDatabaseRecordRow = r
            Exit Function
        End If
    Next r
    FindDatabaseRecordRow = 0
End Function

Private Sub LoadDataFromLocalRow(ws As Worksheet, sourceRow As Long)
    ' Load data from local storage row into form fields
    ws.Unprotect

    Dim combinedMonthWeek As String
    combinedMonthWeek = ws.Cells(sourceRow, 8).value ' Combined Month_Week

    ' Split the combined value
    If InStr(combinedMonthWeek, " : ") > 0 Then
        ws.Range("D14").value = Split(combinedMonthWeek, " : ")(0) ' Month
        ws.Range("E14").value = Split(combinedMonthWeek, " : ")(1) ' Week
    Else
        ws.Range("D14").value = combinedMonthWeek
        ws.Range("E14").value = ""
    End If

    ws.Range("D16").value = ws.Cells(sourceRow, 9).value ' Region
    ws.Range("H6").value = ws.Cells(sourceRow, 10).value ' Engagement ID
    ws.Range("H8").value = ws.Cells(sourceRow, 11).value ' Engagement Hours
    ws.Range("H10").value = ws.Cells(sourceRow, 12).value ' Team Name
    ws.Range("H12").value = ws.Cells(sourceRow, 13).value ' Non-Audit Name
    ws.Range("H14").value = ws.Cells(sourceRow, 14).value ' Non-Audit Hours
    ws.Range("H16").value = ws.Cells(sourceRow, 15).value ' Remarks

    ws.Protect UserInterfaceOnly:=True, AllowFiltering:=True
End Sub

Private Sub LoadDataFromDatabaseRow(ws As Worksheet, wsDB As Worksheet, dbRow As Long)
    ' Load data from database row into form fields
    ws.Unprotect

    Dim combinedMonthWeek As String
    combinedMonthWeek = wsDB.Cells(dbRow, 7).value ' Combined Month_Week

    ' Split the combined value
    If InStr(combinedMonthWeek, " : ") > 0 Then
        ws.Range("D14").value = Split(combinedMonthWeek, " : ")(0) ' Month
        ws.Range("E14").value = Split(combinedMonthWeek, " : ")(1) ' Week
    Else
        ws.Range("D14").value = combinedMonthWeek
        ws.Range("E14").value = ""
    End If

    ws.Range("D16").value = wsDB.Cells(dbRow, 8).value ' Region
    ws.Range("H6").value = wsDB.Cells(dbRow, 9).value ' Engagement ID
    ws.Range("H8").value = wsDB.Cells(dbRow, 10).value ' Engagement Hours
    ws.Range("H10").value = wsDB.Cells(dbRow, 11).value ' Team Name
    ws.Range("H12").value = wsDB.Cells(dbRow, 12).value ' Non-Audit Name
    ws.Range("H14").value = wsDB.Cells(dbRow, 13).value ' Non-Audit Hours
    ws.Range("H16").value = wsDB.Cells(dbRow, 14).value ' Remarks

    ws.Protect UserInterfaceOnly:=True, AllowFiltering:=True
End Sub


Private Sub Worksheet_Activate()
    If Me.Range("D6").value <> "" Then
        Me.Range("D8").Select
    End If
End Sub








this workbook code =======================

Option Explicit

Private Sub Workbook_Open()
    Dim ws As Worksheet
    Dim activeUsers As Collection

    Application.ScreenUpdating = False

    ' Create a collection of sheets that are currently being edited
    Set activeUsers = New Collection
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" Then
            If IsSheetInUse(ws) Then
                activeUsers.Add ws.Name
            End If
        End If
    Next ws

    ' Hide all sheets except Login, Data base, and those being edited
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" Then
            If Not IsInCollection(activeUsers, ws.Name) Then
                ws.Visible = xlSheetVeryHidden
            End If
        End If
    Next ws

    Sheets("Login").Visible = xlSheetVisible
    Sheets("Login").Activate
 
' ====   Start the session timer
     'StartSessionTimer

    Application.ScreenUpdating = True
End Sub
' Helper function to check if a sheet is currently being edited
Private Function IsSheetInUse(ws As Worksheet) As Boolean
    On Error Resume Next
    IsSheetInUse = Not ws.Protection.AllowEditRanges Is Nothing
    On Error GoTo 0
End Function

' Helper function to check if a value is in a collection
Private Function IsInCollection(col As Collection, val As Variant) As Boolean
    Dim item As Variant
    For Each item In col
        If item = val Then
            IsInCollection = True
            Exit Function
        End If
    Next item
    IsInCollection = False
End Function


Private Sub Workbook_SheetActivate(ByVal Sh As Object)
    On Error Resume Next
    If Sh.Name = "Admin" Then
        Call UpdatePendingCounts
    End If
End Sub

Private Sub Workbook_SheetChange(ByVal Sh As Object, ByVal Target As Range)
    Const YEAR_CELL As String = "H1"
    Const MONTH_CELL As String = "D14"

    On Error GoTo ErrorHandler

    ' Debug: Check if the event is triggered
    Debug.Print "Sheet changed: " & Sh.Name & ", Cell: " & Target.Address


    ' Handle Year and Month changes
    If Not (Intersect(Target, Sh.Range(YEAR_CELL)) Is Nothing And _
            Intersect(Target, Sh.Range(MONTH_CELL)) Is Nothing) Then
        HandleYearMonthChange Sh, Target
    End If

    Exit Sub

ErrorHandler:
    Debug.Print "Error " & Err.Number & ": " & Err.Description & " in line " & Erl
    Application.EnableEvents = True
End Sub



Private Sub HandleYearMonthChange(Sh As Worksheet, Target As Range)
    Const YEAR_CELL As String = "H1"
    Const MONTH_CELL As String = "D14"
    Const WEEK_CELL As String = "E14"

    Dim selectedYear As Integer
    Dim selectedMonth As String
    Dim firstDayOfMonth As Date
    Dim lastDayOfMonth As Date
    Dim currentDate As Date
    Dim weekList As New Collection
    Dim weekString As String
    Dim weekArray() As String
    Dim i As Integer

    Application.EnableEvents = False

    ' Unprotect the sheet
    UnprotectSheet Sh

    ' Get the selected year and month
    selectedYear = Sh.Range(YEAR_CELL).value
    selectedMonth = Sh.Range(MONTH_CELL).value

    ' Validate inputs
    If selectedYear = 0 Or selectedMonth = "" Then
        Sh.Range(WEEK_CELL).value = ""
        If HasValidation(Sh.Range(WEEK_CELL)) Then
            Sh.Range(WEEK_CELL).Validation.Delete
        End If
        GoTo CleanUp
    End If

    ' Calculate first and last day of the selected month
    firstDayOfMonth = DateSerial(selectedYear, Month(selectedMonth & " 1"), 1)
    lastDayOfMonth = DateSerial(selectedYear, Month(selectedMonth & " 1") + 1, 0)

    ' Find all Mondays in the month
    currentDate = firstDayOfMonth
    Do While currentDate <= lastDayOfMonth
        If Weekday(currentDate, vbMonday) = 1 Then
           weekString = "Week starting " & Format(currentDate, "mmmm d   yyyy")
            weekList.Add weekString
        End If
        currentDate = currentDate + 1
    Loop

    ' Create an array from the collection
    ReDim weekArray(1 To weekList.count)
    For i = 1 To weekList.count
        weekArray(i) = weekList(i)
    Next i

    ' Remove old validation if it exists
    If HasValidation(Sh.Range(WEEK_CELL)) Then
        Sh.Range(WEEK_CELL).Validation.Delete
    End If

    ' Add new validation
    Sh.Range(WEEK_CELL).Validation.Add _
        Type:=xlValidateList, _
        AlertStyle:=xlValidAlertStop, _
        Formula1:=Join(weekArray, ",")

    ' Clear any old value
    Sh.Range(WEEK_CELL).value = ""

CleanUp:
    ' Protect the sheet again
    ProtectSheet Sh
    Application.EnableEvents = True
End Sub

Private Sub Workbook_BeforeClose(Cancel As Boolean)
   ' Stop the session timer
     ' StopSessionTimer
Dim userName As String
    Dim ws As Worksheet

    ' Get the current user's name
    userName = Environ("USERNAME")

    ' Try to find the sheet that matches the user's name
    For Each ws In ThisWorkbook.Worksheets
        If LCase(ws.Name) = LCase(userName) Then
            ' If the sheet is found and not already hidden, hide it
            If Not ws.Visible = xlSheetHidden Then
                ws.Visible = xlSheetHidden
            End If
            Exit For
        End If
    Next ws

    ' If the sheet doesn't exist, do nothing (no error handling needed)



End Sub







Private Function HasValidation(rng As Range) As Boolean
    On Error Resume Next
    HasValidation = (rng.Validation.Type <> xlValidateInputOnly)
    On Error GoTo 0
End Function

Private Sub UnprotectSheet(ws As Worksheet)
    On Error Resume Next
    ws.Unprotect
    On Error GoTo 0
End Sub

Private Sub ProtectSheet(ws As Worksheet)
    On Error Resume Next
    ws.Protect UserInterfaceOnly:=True
    On Error GoTo 0
End Sub
' Placeholder for UpdatePendingCounts subroutine
Private Sub UpdatePendingCounts()
    ' Add your implementation here
    Debug.Print "UpdatePendingCounts called"
End Sub




